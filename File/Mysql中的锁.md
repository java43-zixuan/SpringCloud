##Mysql中的锁
按照`锁的粒度`分，可以分为以下3类：  
1、全局锁：锁定数据库中的所有表。  
2、表级锁：每次操作锁住整张表。  
3、行级锁：每次操作锁住对应的行数据。

###全局锁
全局锁就是对整个数据库实例加锁，加锁后的整个实例就处于只读状态，后续的DML的写语句，DDL语句，已经更新操作的事务提交语句都将被阻塞。  
`典型的使用场景`就是做全库的逻辑备份，对所有的表进行 行锁定，从而获取一致性视图，保证数据的完整性。

###语法  
1、加全局锁  
```flush tables with read lock;```  
2、数据备份  
```mysqldump -uroot -pxxx db_name -> xxx.sql;```  
3、释放锁  
```unlock tables;```

数据库中加全局锁，是一个比较重的操作，存在的问题有：
- 如果在主库上备份，那么在备份期间都不能执行更新，业务基本上就得停摆。
- 如果在从库上备份，那么在备份期间从库不能执行主库同步过来的二进制日志（binlog），会导致主从延迟。

在InnoDB引擎中，我们可以在备份时加上参数 --single-transaction 参数来完成不加锁的一致 性数据备份。

```mysqldump --single-transaction -uroot -pxxx db_name -> xxx.sql;```

###表级锁
表级锁，每次执行操作时会锁住整张表。锁定粒度大，发生冲突的概率最高，并发度最低。 应用在MyISAM、 InnoDB、BDB等存储引擎中。

####表级锁，主要分为3类：
- 表锁
- 元数据锁（meta data lock，MDL）
- 意向锁

####表锁，又可以分为2类：
- 表共享读锁（read lock）
- 表独占写锁（write lock）

###语法
1、加锁   
```lock tables 表名 ... read/write;```  
2、释放锁  
```unlock tables; / 客户端断开连接```



###行级锁
行级锁，每次操作锁住对应的行数据。锁定粒度最小，发生锁冲突的概率最低，并发度最高。应用在 InnoDB存储引擎中。
InnoDB的数据是基于索引组织的，行锁是通过对索引上的索引项加锁来实现的，而不是对记录加的锁。
对于行级锁，主要分为以下三类：
- 行锁（Record Lock）：锁定单个行记录的锁，防止其他事务对此行进行update和delete。在 RC、RR隔离级别下都支持。
- 间隙锁（Gap Lock）：锁定索引记录间隙（不含该记录），确保索引记录间隙不变，防止其他事 务在这个间隙进行insert，产生幻读。在RR隔离级别下都支持。
- 临键锁（Next-Key Lock）：行锁和间隙锁组合，同时锁住数据，并锁住数据前面的间隙Gap。 在RR隔离级别下支持。

####行锁
InnoDB实现了以下两种类型的行锁：
- 共享锁（S）：允许一个事务去读一行，阻止其他事务获得相同数据集的排它锁。
- 排他锁（X）：允许获取排他锁的事务更新数据，阻止其他事务获得相同数据集的共享锁和排他 锁。

默认情况下，InnoDB在 REPEATABLE READ 事务隔离级别运行，InnoDB使用 next-key 锁进行搜索和索引扫描，以防止幻读。
- 针对唯一索引进行检索时，对已存在的记录进行等值匹配时，将会自动优化为行锁。
- InnoDB的行锁是针对于索引加的锁，不通过索引条件检索数据，那么InnoDB将对表中的所有记录加锁，此时 就会升级为表锁。

####间隙锁 & 临键锁

默认情况下，InnoDB在 REPEATABLE READ 事务隔离级别运行，InnoDB使用 next-key 锁进行搜索和索引扫描，以防止幻读。

- 索引上的等值查询(唯一索引)，给不存在的记录加锁时, 优化为间隙锁 。
- 索引上的等值查询(非唯一普通索引)，向右遍历时最后一个值不满足查询需求时，next-key lock 退化为间隙锁。
- 索引上的范围查询(唯一索引)--会访问到不满足条件的第一个值为止。
注意：间隙锁唯一目的是防止其他事务插入间隙。间隙锁可以共存，一个事务采用的间隙锁不会 阻止另一个事务在同一间隙上采用间隙锁。


#小结
1、概述
在并发访问时，解决数据访问的一致性、有效性问题  
分为全局锁、表级锁、行级锁  

2、全局锁  
对整个数据库示例进行加锁，加锁后整个实例处于只读状态  
性能较差，数据逻辑备份时使用  

3、表级锁
操作锁住整张表，锁定粒度大，发生锁冲突的概率高  
分为表锁、元数据锁、意向锁  
表锁：我们可以对整张表加对应的读锁、写锁，把整张表锁住。  
元数据锁：主要是为了避免我们执行DML语句和DDL语句的冲突问题。  
意向锁：主要是为了规避行锁和表锁它们之间在加锁时的冲突问题，避免表锁在加锁的时候逐行的去检查这张表的行锁情况。意向锁不用手动去加，INDODB引擎会自动加。  

4、行级锁
操作锁住对应的行数据，锁定粒度最小，发生冲突的概率最低  
分为行锁、间隙锁、临键锁  
简单理解：临键锁就是行锁和间隙锁的组合。  
